# CLAUDE.md

本文件为 Claude Code (claude.ai/code) 在本仓库协作开发时的架构与开发指南。

---

## 项目概述

本项目是一个高性能的 PCAP 数据包处理与回放引擎，核心采用 Rust 语言实现，专注于多文件 PCAP 数据集的高效读取、写入、索引、缓存和业务处理。项目采用分层架构，代码全部位于 `src/` 目录下，便于维护和扩展。支持跨平台运行，适用于桌面级网络数据分析、回放等场景。

---

## 架构总览

- **核心语言**：Rust
- **分层结构**：
  - `api/`：对外统一 API 接口，隐藏内部实现复杂性，面向用户和上层调用。
  - `business/`：业务逻辑层，负责配置管理、索引系统、缓存策略、数据处理等核心算法。
  - `data/`：数据访问层，负责底层文件读写、数据模型定义、格式解析与生成。
  - `foundation/`：基础设施层，提供错误处理、trait 定义、通用工具和类型支持。
- **测试与示例**：
  - `tests/`：Rust 单元与集成测试。
  - `examples/`：典型用法示例。

---

## 目录结构

```
.
├── src/
│   ├── api/           # 用户接口层（统一API）
│   ├── business/      # 业务逻辑（配置、索引、缓存、处理器）
│   ├── data/          # 数据访问层（文件IO、数据模型、格式）
│   └── foundation/    # 基础设施（错误、trait、工具、类型）
├── tests/             # 单元/集成测试
├── examples/          # 示例代码
├── data/              # 测试数据集
├── docs/              # 设计与说明文档
├── Cargo.toml         # Rust 配置
├── Cargo.lock         # 依赖锁定
└── README.md          # 项目说明
```

---

## 核心数据流

1. 用户通过 API（src/api/）调用统一接口，进行数据集的读取、写入、索引生成等操作。
2. API 层自动调度 business 层的配置、索引、缓存、数据处理等核心逻辑。
3. business 层根据需要调用 data 层进行底层文件读写、数据模型转换、格式解析。
4. 所有错误、trait、工具和类型由 foundation 层统一提供和管理。
5. 测试和示例通过 API 层驱动全流程，验证各层协作正确性。

---

## 模块职责表

| 模块            | 职责/功能                   | 说明                                 |
|-----------------|-----------------------------|--------------------------------------|
| **api/**        | 用户接口层                  | 统一 API，隐藏内部复杂性             |
| **business/**   | 业务逻辑/索引/缓存/配置     | 配置管理、索引系统、缓存、数据处理   |
| **data/**       | 数据访问层                  | 文件 IO、数据模型、格式解析          |
| **foundation/** | 基础设施                    | 错误处理、trait、工具、类型定义      |
| **tests/**      | 单元/集成测试               | Rust 测试用例                        |
| **examples/**   | 示例代码                    | 典型用法演示                         |

---

## 开发命令

```bash
# 运行全部测试
cargo test

# 运行指定测试
cargo test test_name

# 性能基准测试
cargo bench

# 运行示例
cargo run --example name
```

---

## 关键技术

- **Rust 分层架构**：api、business、data、foundation 四层解耦，便于维护和扩展。
- **高性能 PCAP 处理**：支持多文件数据集、索引、缓存、批量处理。
- **统一错误处理**：thiserror + 自定义错误类型，异常管理清晰。
- **强类型与文档注释**：所有核心结构和接口均有类型注解和文档说明。
- **测试驱动开发**：tests/ 目录下覆盖单元与集成测试。
- **跨平台支持**：兼容 Windows、Linux、macOS。

---

## 重要说明

- 目录结构与文档描述完全一致，便于新成员快速上手。
- 推荐先阅读 `api/` 和 `business/` 目录下的文档注释理解整体流程。
- 测试和示例可直接运行，验证功能和性能。
- 如需扩展新功能，建议遵循现有分层架构，保持代码整洁。

---

## 开发流程

本项目采用 SPECS 驱动开发方法，结合 EARS (Event-driven, Asynchronous, Reactive, Stateful) 规范进行需求分析和系统设计。

### 核心原则

#### 效率原则
- 并行执行优于顺序执行，识别可同时进行的任务
- 每个阶段输出最小可验证版本，避免过度设计
- 30分钟无进展即停止重新评估方法
- 所有交付物必须能独立部署运行

#### 质量原则
- 代码包含完整类型注解、文档注释，10分钟内可理解
- 零配置运行：一条命令即可启动，包含完整依赖
- 安全优先：输入验证、权限检查、数据保护
- 跨平台验证：Windows、macOS、Linux兼容或明确限制

#### 协作原则
- 技术术语配简要解释，确保理解一致
- 决策记录原因、备选方案、风险评估
- 问题报告包含：描述、复现、影响、解决方案
- 每次交流包含需求编号、设计章节、代码位置引用

### 工作流程

#### 阶段控制
每个阶段完成后停止工作，等待明确确认后进入下一阶段。

**需求触发词汇：** "我想要"、"需要实现"、"帮我做"、"创建"、"修改"、"增加功能"

**阶段门禁：**
- 需求→设计：需求文档完成，EARS格式验收标准编写完整
- 设计→实施：技术设计完成，架构图绘制，API设计定义
- 开始执行：任务拆分完成，依赖关系明确，工时估算完整

#### SPECS 驱动开发

采用需求、设计、实施三阶段结构化开发方法。

##### 需求收集与分析

**目标：** 将用户想法转化为完整需求文档

**执行标准：**
- 3轮对话内完成需求文档，避免无限询问
- 所有验收标准使用EARS格式（WHEN、IF、WHILE、WHERE）
- 用户故事包含角色、功能、价值三要素
- 文档位置：`.specs/{feature_name}/requirements.md`

**EARS 语法说明：**
- **普遍需求：** THE [系统名称] SHALL [系统响应]
- **事件驱动：** WHEN [触发事件] THE [系统名称] SHALL [系统响应]
- **状态驱动：** WHILE [持续条件] THE [系统名称] SHALL [系统响应]
- **可选特性：** WHERE [功能包含] THE [系统名称] SHALL [系统响应]
- **复杂需求：** WHEN [事件] AND IF [条件] THEN THE [系统名称] SHALL [响应]

##### 技术方案设计

**目标：** 基于需求创建详细技术设计

**执行标准：**
- 每个技术决策引用对应需求编号
- 包含系统架构图、组件设计、数据模型、API设计
- 说明技术选择原因和备选方案
- 详细错误分类、错误码、处理策略
- 覆盖单元、集成、端到端测试策略
- 文档位置：`.specs/{feature_name}/design.md`

##### 任务拆分与实施

**目标：** 转化为可执行编码任务

**执行标准：**
- 每个任务引用对应设计章节和需求编号
- 任务具体可在2-8小时完成，包含输入、输出、验收标准
- 按测试驱动开发组织：编写测试→实现功能→重构优化
- 使用DAG表示任务依赖，标注并行任务
- 包含工时估算，总工时不超过40小时
- 文档位置：`.specs/{feature_name}/tasks.md`

### 执行规则

#### 任务执行
1. 单任务原子性：每次执行一个任务，完成后立即停止等待确认
2. 上下文读取：执行前先读取requirements.md、design.md、tasks.md
3. 质量门禁：代码语法检查、单元测试通过、安全扫描、跨平台验证
4. 问题上报：技术困难、需求歧义、设计缺陷、安全风险时立即停止上报
5. 并行验证：开始前检查依赖关系，有可并行任务组一次性执行
6. 安全评估：检查用户输入、敏感数据、权限控制
7. 平台测试：系统调用、文件操作、网络访问在Windows环境验证

#### 质量控制

##### 需求审查检查清单
- [ ] 所有需求采用正确EARS格式
- [ ] 用户故事清晰明确，包含角色、功能、价值
- [ ] 验收标准具体可测试
- [ ] 覆盖所有功能和非功能性需求
- [ ] 约束条件明确定义

##### 设计审查检查清单
- [ ] 架构设计合理，组件职责清晰
- [ ] API设计符合RESTful原则
- [ ] 数据模型设计规范
- [ ] 错误处理策略完整
- [ ] 测试策略覆盖全面
- [ ] 安全和性能考虑充分
- [ ] 跨平台兼容性已考虑
- [ ] 代码质量要求已明确
- [ ] 并行开发可能性已评估

##### 任务审查检查清单
- [ ] 每个任务都是具体编码活动
- [ ] 任务间依赖关系清晰
- [ ] 任务粒度适中（2-8小时）
- [ ] 每个任务引用相关需求
- [ ] 包含充分测试任务
- [ ] 任务顺序符合开发最佳实践

> 本文档持续更新，建议所有开发者优先查阅本文件以理解整体架构与开发规范。
